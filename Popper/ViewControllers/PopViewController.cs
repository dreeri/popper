// This file has been autogenerated from a class added in the UI designer.

using System;
using CoreGraphics;
using Facebook.Pop;
using Foundation;
using Popper.Utilities;
using UIKit;

namespace Popper
{
    public partial class PopViewController : UIViewController
    {
        enum BoxLocation
        {
            NorthEast,
            SouthEast,
            SouthWest,
            NorthWest
        }

        float DynamicsMass;
        float DynamicsTension;
        float DynamicsFriction;

        BoxLocation Location;

        public PopViewController(IntPtr handle) : base(handle)
        {
        }

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();
            InitBox();
        }

        public override void ViewDidAppear(bool animated)
        {
            base.ViewDidAppear(animated);
            InitButtons();
            GetUserDefaults();
        }

        public override void ViewDidDisappear(bool animated)
        {
            base.ViewDidDisappear(animated);
            button1.TouchUpInside -= Button1TouchUpInside;
            button1.TouchDown -= Button1TouchDown;
        }

        void GetUserDefaults()
        {
            DynamicsMass = NSUserDefaults.StandardUserDefaults.FloatForKey("slider1");
            DynamicsTension = NSUserDefaults.StandardUserDefaults.FloatForKey("slider2");
            DynamicsFriction = NSUserDefaults.StandardUserDefaults.FloatForKey("slider3");

            var minimumDynamicValue = 1f;
            DynamicsMass = DynamicsMass < minimumDynamicValue ? Constants.DefaultPopDynamicsMass : DynamicsMass;
            DynamicsTension = DynamicsTension < minimumDynamicValue ? Constants.DefaultPopDynamicsTension : DynamicsTension;
            DynamicsFriction = DynamicsFriction < minimumDynamicValue ? Constants.DefaultPopDynamicsFriction : DynamicsFriction;
        }

        CGPoint CalculateBoxLocation()
        {
            var screenWidth = UIScreen.MainScreen.Bounds.Width;
            var screenHeight = UIScreen.MainScreen.Bounds.Height;

            var statusBarHeight = 20f;
            var halfWidth = Constants.DefaultBoxEdge / 2;
            var halfHeight = Constants.DefaultBoxEdge / 2;
            var defaultTabBarHeight = 59f;
            var tabBarHeight = TabBarController?.TabBar.Bounds.Size.Height ?? defaultTabBarHeight;
            switch (Location)
            {
                case BoxLocation.NorthEast:
                    return new CGPoint(screenWidth - halfWidth, halfHeight + statusBarHeight);
                case BoxLocation.SouthEast:
                    return new CGPoint(screenWidth - halfWidth, screenHeight - halfHeight - tabBarHeight);
                case BoxLocation.SouthWest:
                    return new CGPoint(halfWidth, screenHeight - halfHeight - tabBarHeight);
                case BoxLocation.NorthWest:
                    return new CGPoint(halfWidth, halfHeight + statusBarHeight);
                default:
                    return new CGPoint(0, 0);
            }
        }

        void BoxLocationAnimation()
        {
            var animationSize = POPSpringAnimation.AnimationWithPropertyNamed(POPAnimation.LayerBounds);
            var size = new CGSize(Constants.DefaultBoxEdge, Constants.DefaultBoxEdge);
            animationSize.ToValue = NSValue.FromCGSize(size);
            animationSize.DynamicsMass = DynamicsMass;
            animationSize.DynamicsTension = DynamicsTension;
            animationSize.DynamicsFriction = DynamicsFriction;
            animationView.Layer.AddAnimation(animationSize, "size");

            var animation = POPSpringAnimation.AnimationWithPropertyNamed(POPAnimation.LayerPosition);
            var location = CalculateBoxLocation();
            animation.ToValue = NSValue.FromCGPoint(location);
            animation.DynamicsMass = DynamicsMass;
            animation.DynamicsTension = DynamicsTension;
            animation.DynamicsFriction = DynamicsFriction;
            animationView.Layer.AddAnimation(animation, "location");
        }

        void BoxSizeAnimation()
        {
            var animationSize = POPSpringAnimation.AnimationWithPropertyNamed(POPAnimation.LayerBounds);
            var multiplier = 0.7;

            var size = new CGSize(Constants.DefaultBoxEdge * multiplier, Constants.DefaultBoxEdge * multiplier);
            animationSize.ToValue = NSValue.FromCGRect(new CGRect(new CGPoint(0, 0), size));
            animationSize.DynamicsMass = DynamicsMass;
            animationSize.DynamicsTension = DynamicsTension;
            animationSize.DynamicsFriction = DynamicsFriction;
            animationView.Layer.AddAnimation(animationSize, "size");
        }

        void InitButtons()
        {
            button1.TouchUpInside += Button1TouchUpInside;
            button1.TouchDown += Button1TouchDown;
        }

        void CountNewBoxLocation()
        {
            var boxLocationLength = Enum.GetNames(typeof(BoxLocation)).Length - 1;
            var index = (int)Location < boxLocationLength ? 1 : -(boxLocationLength);
            Location = (BoxLocation)((int)Location + index);
        }

        void Button1TouchUpInside(object sender, EventArgs e)
        {
            CountNewBoxLocation();
            BoxLocationAnimation();
        }

        void Button1TouchDown(object sender, EventArgs e)
        {
            BoxSizeAnimation();
        }

        void InitBox()
        {
            var statusBarHeight = 20;
            animationView.Frame = new CGRect(UIScreen.MainScreen.Bounds.Width - Constants.DefaultBoxEdge, statusBarHeight, Constants.DefaultBoxEdge, Constants.DefaultBoxEdge);
        }
    }
}
